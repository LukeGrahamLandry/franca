
ENABLE_TRACY :: Foreign.ENV.FRANCA_TRACY.get_environment_variable().is_some();

TraceCtx :: @if(ENABLE_TRACY, TracyZoneContext, void);

TraceZone :: @enum(i64) (EmitIr, AotPump, Backend, Scope, LoadFile, Parse, SemaFunction, SemaOverloads, Task, CallDynamic, BakeConstArgs, Wait, CloneExpr, CheckCache, ImportCache);
// TODO: can't index by pointer a const array
ZONE_COLOURS :: @static(Array(u32, enum_count(TraceZone))) @array(0x00FF0066, 0x00FF0000, 0x00FF6600, 0x0000FF00, 0x000000FF, 0x000000FF, 
    0x00FF00FF, 0x00EE00AA, 0x00AAFFAA, 0x00888800, 0x00AA0099, 0x00000001, 0x0000FF44, 0x000055FF, import_cache_colour);

import_cache_colour :: 0x335533FF;
// TODO: caller location
fn zone_begin(zone: TraceZone) TraceCtx = {
    @if(!ENABLE_TRACY) return();
        src :: {
            n := ast_alloc().alloc_zeroed(TracySourceLocation, enum_count(TraceZone));
            for_enum TraceZone { e |
                n[@as(i64) e] = (
                    name = e.name_str().sym().c_str(),
                    function = "",
                    file = "",
                    line = 0, 
                    color = ZONE_COLOURS.items()[e.raw()],
                );
            };
            n
        };
        ZONE_COLOURS;
        s := src.index(@as(i64) zone);
        ___tracy_emit_zone_begin(s, 1)
};

fn zone_end(c: TraceCtx) void = {
    @if(ENABLE_TRACY, ___tracy_emit_zone_end(c), ());
}

//! https://github.com/wolfpld/tracy/blob/master/public/tracy/TracyC.h

TracySourceLocation :: @struct(
    name: CStr, // ?
    function: CStr,
    file: CStr,
    line: u32,
    color: u32,
);

TracyZoneContext :: @struct(
    id: u32,
    active: i32,
);

fn ___tracy_emit_zone_begin(srcloc: *TracySourceLocation, active: i32) TracyZoneContext #import("tracy");
// Note: these rely on the abi of slices being the same as seperate ptr/len arguments
fn ___tracy_emit_zone_text(ctx: TracyZoneContext, txt: []u8) void #import("tracy");  
fn ___tracy_emit_zone_name(ctx: TracyZoneContext, txt: []u8) void #import("tracy");
fn ___tracy_emit_zone_color(ctx: TracyZoneContext, color: u32) void #import("tracy");
fn ___tracy_emit_zone_end(ctx: TracyZoneContext) void #import("tracy");

// /Users/luke/Downloads/tracy-master/profiler/cmake-build-release/tracy-profiler
// FRANCA_TRACY=true franca examples/default_driver.fr build compiler/main.fr -o trace.out
