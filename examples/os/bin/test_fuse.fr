
main :: fn() void = {
    b_txt := Posix'openat(Posix'AT'FDCWD(), "target/b.txt".as_cstr(), Posix'O'RDWR, 0)
        || @panic("failed to open target/b.txt\n(probably failed to mount shared folder)");
    buf := "The contents of b.txt is this string";
    writen_len := Syscall'write(b_txt, buf.ptr, buf.len)
        || @panic("failed write b.txt");
    @println("WRITE: %/%", writen_len, buf.len);
    Syscall'close(b_txt);
    bytes := read_entire_file_or_crash(temp(), "target/b.txt");
    @println("b.txt: %", bytes);
        
    bytes := read_entire_file_or_crash(temp(), "target/a.txt");
    @println("ALL: %", bytes);
    
    fuse_root := Posix'openat(Posix'AT'FDCWD(), "target".as_cstr(), Posix'O'RDONLY, 0)
        || @panic("failed to open target/shared");
    
    fd := Posix'openat(fuse_root, "a.txt".as_cstr(), Posix'O'RDWR, 0)
        || @panic("failed to open");
    
    _ := Syscall'lseek(fd, 0, .Set) 
        || @panic("failed lseek");
        
    buf := @tfmt("Goodbye World %!", timestamp());
    writen_len := Syscall'write(fd, buf.ptr, buf.len)
        || @panic("failed write");
    @println("WRITE: %/%", writen_len, buf.len);
    
    pos := Syscall'lseek(fd, 10, .Set) 
        || @panic("failed lseek");
    @println("seek to %", pos);
    
    out := u8.list(1000, temp());
    read_len := Syscall'read(fd, out.items().end_pointer(), out.maybe_uninit.len - out.len) 
        || @panic("failed read");
    out.len += read_len;
    @println("READ(%): %", read_len, out.items());
    
    Syscall'close(fd);
    
    bytes := read_entire_file_or_crash(temp(), "target/shared/foo/bar.txt");
    @println("foo/bar.txt: %", bytes);
}

#use("@/lib/sys/fs.fr");
