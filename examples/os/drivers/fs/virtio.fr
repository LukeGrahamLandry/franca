// Virtio File System Device (mounting a shared directory from the host)

Self :: @struct {
    device: Virt.Device;
    label: Array(u8, 40);
};

HIPRIO :: 0;
REQUEST :: 1;  // note: no VIRTIO_FS_F_NOTIFICATION

find :: fn(pci: *Pci.MemoryRegion) ?Self = {
    // TODO: support multiple shared directories (userspace can pick one by the tag)
    it := Virt'find(pci, 26) 
        || return(.None);
    feat := 1.shift_left(32);  // VIRTIO_F_VERSION_1
    agree := it.cfg.init_features(feat);
    @if(agree != feat) kpanic("didn't agree on device features");
    config := it.device_config.unwrap();
    config := config&.pop_type(Config);
    kprint("FUSE!\n");
    tag := config.get_tag();
    label := zeroed Array(u8, 40);
    label&.items().slice(0, tag.len).copy_from(tag);
    label&[tag.len + 0] = ".".ascii();
    label&[tag.len + 1] = "f".ascii();
    label&[tag.len + 2] = "s".ascii();
    label&[tag.len + 3] = 0;
    kprint_label("intid = ", it.intid);
    
    buf := kernel.physical&.map_contiguous(1.shift_left(16), 1);
    each buf { it |
        it[] = 0;
    };
    
    qs := buf&.pop_slice(Virt.Queue, 2);
    self: Self = (device = (queues = qs, interrupt_status = it.status, intid = it.intid), label = label);
    init_queue(it.cfg, qs.index(REQUEST), REQUEST, buf&, 128, it.note);
    init_queue(it.cfg, qs.index(HIPRIO), HIPRIO, buf&, 128, it.note);
    it.cfg.publish_queues();
    (Some = self)
}

Config :: @struct {
    tag: Array(u8, 36);
    num_request_queues: u32;
    // note: no VIRTIO_FS_F_NOTIFICATION
    // notify_buf_size: u32;
};

fn get_tag(config: *Config) Str #inline/*semantic*/ = {
    // if you don't do this the painful way it doesn't work. 
    // (because its jail to copy_from because that does unaligned access? 
    //  and you can't put the bar memory in a virt queue to print?)
    tag_v := config.tag&.items();
    tag_v := tag_v&.pop_cstr();
    tag := @uninitialized Array(u8, 26);
    range(0, tag_v.len) { i |
        tag&[i] = tag_v[i];
    };
    tag := tag&.items().slice(0, tag_v.len);
    tag
}

Fuse :: import("@/examples/os/drivers/fs/fuse.fr");
