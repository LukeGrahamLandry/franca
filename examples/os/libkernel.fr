
// saved and restored on interrupt/signal/syscall
MContext :: @struct {
    gpr: Array(i64, 32);
    // why are we being interrupted?
    esr: i64;  // exception syndrome
    far: i64;  // fault address
    // how do we return after the interrupt?
    elr: i64;  // eret link register
    spsr: i64; // saved program status
    //
    fpr: Array(i64, 64);
};

// set when creating a thread and then mostly stable
ThreadConfig :: @struct {
    signal_handler: SignalHandler.F;
    signal_stack_buf: []u8;
    exit_futex: *u32;
};

// todo: get rid of this
SignalHandler :: @struct {
    callee: F;
    stack: []u8;
    F :: @FnPtr(ctx: *MContext, intid: i64, data: i64) Ty(i64, *MContext);
};

// TODO: this is not at all a safe or secure interface
UQueue :: @rec @struct {
    pipe: QRing'Cycle(Entry);
    system_handle: rawptr;
    poll: Poll;
    
    Entry :: @struct {
        bufs: [][]u8;
        n: @union(
            bufs_readable: i32,
            bytes_written: u32,
        );
        system_id: u32 = MAX_u32;
    };
    Poll :: @FnPtr(self: *UQueue, who: i64) void;
    QRing :: import("@/lib/sys/sync/qring.fr");
};

// this sets it.(poll, system_handle)
fn virtq_create(it: *UQueue, label: Str, n: i64) bool = {
    @if(query_current_arch() == .wasm32) return(false);
    args: Array(i64, 6) = (UQueue.int_from_ptr(it), u8.int_from_ptr(label.ptr), label.len, n, 0, 0);
    result, _ := Syscall'perform_syscall(args&, 0xFFFF0008);
    result == 0
}

fn virt_translate(virtual: []u8, out: [][]u8) ?[][]u8 = {
    args: Array(i64, 6) = (
        u8.int_from_ptr(virtual.ptr), 
        virtual.len, 
        Slice(u8).int_from_ptr(out.ptr), 
        out.len, 
    ..0);
    count, _ := Syscall'perform_syscall(args&, 0xFFFF000A);
    @if(count > out.len || count < 0) return(.None);
    (Some = out.slice(0, count))
}

fn sys_debug_write(msg: Str) void = {
    args: Array(i64, 6) = (u8.int_from_ptr(msg.ptr), msg.len, 0, 0, 0, 0);
    _ := Syscall'perform_syscall(args&, 0xFFFF0009);  // debug_write
}
