
MContext :: @struct {
    gpr: Array(i64, 32);
    // why are we being interrupted?
    esr: i64;  // exception syndrome
    far: i64;  // fault address
    // how do we return after the interrupt?
    elr: i64;  // eret link register
    spsr: i64; // saved program status
    intid: i64;
    _: i64;
    //
    fpr: Array(i64, 64);
};

SignalHandler :: @struct {
    callee: @FnPtr(ctx: *MContext, intid: i64, data: i64) i64;
    stack: []u8;
};

fn set_signal_handler(new: SignalHandler) SignalHandler = {
    old := zeroed SignalHandler;
    args: Array(i64, 6) = (SignalHandler.int_from_ptr(new&), SignalHandler.int_from_ptr(old&), 0, 0, 0, 0);
    Syscall'perform_syscall(args&, 0xFFFF0003);  // sig_action
    old
}

UQueue :: @rec @struct {
    pipe: QRing'Cycle(Entry);
    system_handle: rawptr;
    poll: Poll;
    
    Entry :: @struct {
        bufs: [][]u8;
        n: @union(
            bufs_readable: i32,
            bytes_written: u32,
        );
        system_id: u32 = MAX_u32;
    };
    Poll :: @FnPtr(self: *UQueue, who: i64) void;
    QRing :: import("@/lib/sys/sync/qring.fr");
};

fn virtq_poll(it: *UQueue, _: i64) void = {
    args: Array(i64, 6) = (UQueue.int_from_ptr(it), 0, 0, 0, 0, 0);
    _ := Syscall'perform_syscall(args&, 0xFFFF0007);
}

fn virtq_create(it: *UQueue, label: Str, n: i64) bool = {
    it.poll = virtq_poll;
    args: Array(i64, 6) = (UQueue.int_from_ptr(it), u8.int_from_ptr(label.ptr), label.len, n, 0, 0);
    result, _ := Syscall'perform_syscall(args&, 0xFFFF0008);
    result == 0
}

// TODO: pass something like this to user space init
SystemInfo :: @struct {
    page_size_shift: u8;
    device_tree: []u8;
};
