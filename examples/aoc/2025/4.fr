
main :: fn() void = {
    s := import("@/lib/sys/fs.fr")'read_file_from_last_arg();
    s := s.split("\n", temp()).items();
    
    one := count(s);    
    two := one;
    dowhile {
        removed := count(s);
        two += removed;
        removed != 0
    };
    println(one);
    println(two);
}

count :: fn(s: [][]u8) i64 = {
    DIR :: @const_slice((-1, 1), (1, -1), (-1, -1), (1, 1), (0, 1), (0, -1), (1, 0), (-1, 0));
    w := s[0].len;
    h := s.len;
    remove := Ty(i64, i64).list(temp());
    range(0, w) { x |
        range(0, h) { y |
            continue :: local_return;
            if s[y][x] != "@".ascii() {
                continue();
            };
            n := 0;
            for DIR { dx, dy |
                xx, yy := (x + dx, y + dy);
                if yy < h && yy >= 0 && xx < w && xx >= 0 {
                    n += int(s[yy][xx] == "@".ascii());
                }
            };
            if n < 4 {
                push(remove&, (x, y));
            }
        };
    };
    for remove { x, y |
        s[y][x] = ".".ascii();
    };
    remove.len
}
