#!/usr/bin/env franca
// Report which environment the compiler thinks you're targetting. 
// This is nice for testing that i can cross compile and run with rosetta2. 
// franca examples/default_driver.fr run examples/toy/where_am_i.fr -arch x86_64

main :: fn() = {
    @run show("Comptime");
    show("Runtime");
}

show :: fn(when: Str) void = {
    #use("@/lib/sys/process.fr");
    arch, os := (query_current_arch(), query_current_os());
    @println("%: % % dyn_libc=%", when, arch, os, !tls(.prefer_syscalls)[]);
    print_uname();
}

print_uname :: fn() void = {
    field_names :: @const_slice("sysname", "nodename", "release", "version", "machine");
    field_size := @if(query_current_os() == .linux, 65, 256);
    uname :: @(Syscall.S)("uname") fn(buf: *u8) i64 #weak #libc #syscall(160, 63, NOSYS);
    // +1 for domainname on linux
    buf := temp().alloc_zeroed(u8, (field_names.len() + 1) * field_size);
    uname(buf.ptr);
    enumerate field_names { i, name |
        value: CStr = (ptr = buf.ptr.offset(i * field_size));
        @println("- %: %", name[], value);
    };
}
