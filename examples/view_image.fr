main :: fn() void #use(Wuffs) = {
    p, w, h := {
        data := g_src_ptr__mona_lisa_21_32_q50_jpeg;
        channels_in_file :i32= 0;
        src_w :i32= 0;
        src_h :i32= 0;
        bytes_per_pixel :i32= 3; 
        pixels := stbi_load_from_memory(data.ptr, data.len.intcast(), src_w&, src_h&, zeroed(*i32), bytes_per_pixel);
        (pixels, src_w, src_h)
    };
    i := 0;
    out := u8.list(temp());
    @fmt(out&, "P3 % % 255\n", w, h);
    range(0, h.intcast()) { y |
        range(0, w.intcast()) { x |
            @fmt(out&, "% % % ", p.offset(i)[], p.offset(i + 1)[], p.offset(i + 2)[]);
            i += 3;
        };
        @fmt(out&, "\n");
    };
    @println("%", out.items());
}

Wuffs :: {
    get  :: import("@/examples/testing.fr").fetch_or_crash;
    root := get("https://github.com/google/wuffs/archive/b1174882799a6d39796a14c9b28fb4977144a480.zip", 16126015, "2725c410cd083fbd76740936a3310fe9dd1c022ce701655e3819123e6fa8339c", "wuffs-b1174882799a6d39796a14c9b28fb4977144a480");
    Ffi  :: import("@/examples/import_c/ffi.fr");
    data := @tfmt("%/test/data/mona-lisa.21x32.q50.jpeg", root);
    data := ast_alloc().read_to_string_or_crash(data).items();
    namespace :: scope_of(Type, @struct { 
        g_src_ptr__mona_lisa_21_32_q50_jpeg :: @static([]u8);
    });
    namespace.g_src_ptr__mona_lisa_21_32_q50_jpeg[] = data;
    c_source := @tfmt("""
        #define WUFFS_IMPLEMENTATION
        #define WUFFS_CONFIG__MODULES
        #define WUFFS_CONFIG__MODULE__JPEG
        #define WUFFS_CONFIG__MODULE__BASE
        #define WUFFS_CONFIG__ENABLE_DROP_IN_REPLACEMENT__STB
        typedef struct{} FILE;  // HACK
        #include "%/release/c/wuffs-unsupported-snapshot.c"
    """, root);
    Ffi'include(current_compiler_context(), namespace, c_source);
    namespace
}

#include_std("backend/lib.fr");
