Qbe :: import("@/backend/lib.fr");
C :: import("@/examples/import_c/lib.fr");
Ffi :: import("@/examples/import_c/ffi.fr");

#use("@/examples/web/demo.fr")
main :: fn() void = { 
    args := get_args("");
    src := args.src;

    m := @uninitialized Qbe.Module; m := m&;
    Qbe'backend'init_module(m, args.target);
    m.set_debug_types(args.logging, true);
    
    parse :: import("@/backend/meta/parse.fr").parse_top_level;
    res := parse(m, src, Qbe'backend'compile_dat, Qbe.backend.compile_fn);
    if res&.is_err() {
        panic(res.Err);
    };
    
    sections := import("@/backend/meta/qbe_frontend.fr")'extract_sections(src);
    if sections&.get("driver") { src |
        c := C'Compile.Ctx.zeroed();
        ctx := init_codegen_worker(m, false);
        Ffi'import_c'init_c(c&, m, ctx);
        // TODO: this way of doing it means you lose location information which sucks
        result := Ffi'import_c'compile_c(c&, ">>>driver", src);
        result.or(fn(e) => panic(e));
        c.arena_storage&.deinit();
        Qbe'backend'worker_join(ctx);
    }
    
    yield_module_main(m);
}
