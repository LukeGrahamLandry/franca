C :: import("@/examples/import_c/lib.fr");

#use("@/backend/lib.fr");

#use("@/examples/web/demo.fr")
main :: fn() void = {
    args := get_args("");
    m := @uninitialized QbeModule;
    
    backend'init_module(m&, args.target);
    m&.set_debug_types(args.logging, true);
    
    ctx: *C.Compile.CodegenShared = backend'worker_start(m&, general_allocator(), backend.worker_thread, false);
    
    c := C'Compile.Ctx.zeroed();
    import_c'init_c(c&, m&);
    c.include_paths.len = 0;
    c.preserve_franca_env = true;
    c.emitter = (Some = ctx);
    c.enqueue_task = backend.worker_enqueue; 
    
    c&.import_c'compile_c("-", args.src)
        .or(fn(err) => panic(err));
    ctx.backend'worker_join();
    c.arena_storage&.deinit();

    ::enum(@type m.goal.type);
    
    yield_module_main(m&);
}

#use("@/examples/import_c/ffi.fr");

//long write(int a, long b, long c);
//int main() {
//write(1, "Hello", 5);
//return 1-1;
//}