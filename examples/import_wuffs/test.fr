main :: fn() void = {
    parse_test();
}

parse_test :: fn() void = {
    root := import("@/examples/import_c/test/wuffs.fr")'root();
    dirs := collect_directory_ordered(@tfmt("%/std", root), temp(), temp()).unwrap();
    program: Program = (names = init(temp()), arena = temp());
    
    for dirs { it |
        module: Module = (name = program.names&.insert_owned(it.name), arena = temp(), program = program&);
        module&.new_node(Empty, ());
        files := collect_directory_ordered(@tfmt("%/std/%", root, it.name), temp(), temp()).unwrap();
        for files { jt |
            if jt.name.ends_with(".wuffs") {
                src := read_entire_file_or_crash(temp(), @tfmt("%/std/%/%", root, it.name, jt.name));
                @println("=== % ===", jt.name);
                parse_top_level(src, program&, module&);
            }
        };
        
        out := u8.list(temp());
        p: Print = (module = module&, out = out&);
        each module.body& { it |
            show(p&, it);
        };
        print(out.items());
    };
};

#use("@/examples/import_wuffs/lex.fr");
#use("@/examples/import_wuffs/ast.fr");
#use("@/examples/import_wuffs/parse.fr");
#use("@/examples/import_wuffs/print.fr");
