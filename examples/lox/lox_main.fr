/// An implementation of the lox language from CraftingIntepreters.com.
/// It's a pretty direct port of clox (the second implementation in the book). 
/// Following that book was how I wrote my first compiler so it seems cool to use that as a test project for my new language. 

// TODO: read from file/repl. 
main :: fn() void = lox_stmts();
#use("@/lib/collections/map.fr");

fn lox_stmts() = {
    #use(Lox);

    vm: Vm = init_vm();
    vm&.interpret("return -(1 + 2);");
    assert_eq(vm.last_return.to_number(), 3.0.neg());
    
    vm&.interpret("return 3 - 1;");
    assert_eq(vm.last_return.to_number(), 2.0);
    
    vm&.interpret("return !true;");
    assert_eq(vm.last_return.to_bool(), false);
    
    vm&.interpret("return !(3 > 5) == 3 <= 5;");
    assert_eq(vm.last_return.to_bool(), true);
    
    vm&.interpret("return \"hello\" == \"world\";");
    assert_eq(vm.last_return.to_bool(), false);
    
    vm&.interpret("return \"hello world\" == \"hello\" + \" world\";");
    assert_eq(vm.last_return.to_bool(), true);
   
    // TODO: capture so it's not spammy in the test
    //vm&.interpret("print \"hello world\"; return nil;");
    
    vm&.interpret("var a = 123; // comment!\n return a;");
    assert_eq(vm.last_return.to_number(), 123.0);
    
    vm&.interpret("var a = 123; a = 456; return a;");
    assert_eq(vm.last_return.to_number(), 456.0);
    vm&.interpret("{ var b = 123; b = 456; return b; }");
    assert_eq(vm.last_return.to_number(), 456.0);
    
    vm&.interpret("{ var b = 1; if (b == 1) { b = 2.5; } return b; }");
    assert_eq(vm.last_return.to_number(), 2.5);
    
    vm&.interpret("{ var b = 1; if (b == 1) { b = 5; } else { b = 4; } return b; }");
    assert_eq(vm.last_return.to_number(), 5.0);
    
    vm&.interpret("{ var b = 2; if (b == 1) { b = 4; } else { b = 3; } return b; }");
    assert_eq(vm.last_return.to_number(), 3.0);
    
    vm&.interpret("{ var c = 0; var a = 0; while (c < 3) a = a + (c = c + 1.0); return a; }");
    assert_eq(vm.last_return.to_number(), 6.0);
    vm&.interpret("{ var a = 0; for (var c = 0; c < 3; c = c + 1) a = a + c + 1.0; return a; }");
    assert_eq(vm.last_return.to_number(), 6.0);
    
    vm&.interpret(src);
    
    vm&.drop();
}

src :: """
return;
""";

Lox :: {
// ugh: my language does not spark joy :(
::ptr_utils(u8);
::ptr_utils(X.Value);
::ptr_utils(X.Obj);
::if(X.Value);
X :: @struct {
    #reexport("@/examples/lox/chunk.fr");
    #reexport("@/examples/lox/value.fr");
    #reexport("@/examples/lox/vm.fr");
    #reexport("@/examples/lox/scanner.fr");
    #reexport("@/examples/lox/compile.fr");
};
X
};
