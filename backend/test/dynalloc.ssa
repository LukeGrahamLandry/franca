# make sure dynamic allocations
# and caller-save regs interact
# soundly

export
function w $main() {
@start
    %a =w call $f(w 0, l 16)
    %b =w call $f(w 0, l 16)
    %_ =l call $big_const_alloc(w 0)
    ret %a
}

function w $f(w %arg, l %sixteen) {
@start
    call $g()
@alloc
    %r =l alloc8 %sixteen
    storel 180388626474, %r
    %r8 =l add 8, %r
    storel 180388626474, %r8
    ret %arg
}

function l $big_const_alloc(w %zero) {
@start
    # prevent collapsing the blocks and making it a fast-local
    jnz %zero, @crash, @alloc  
@alloc
    # make sure to fixarg the salloc
    %r =l alloc8 123456
    ret %r
@crash
    hlt
}

function $g() {
@start
    ret
}
