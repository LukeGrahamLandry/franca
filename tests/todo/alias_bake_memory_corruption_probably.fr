#include_std("lib/core.fr");
#include_std("compiler/lib.fr");

DEBUG_SPAM_LOG :: false;
DISABLE_IMPORT_FRC :: true;  // TODO: need to fix this because terminal.fr imports this in a namespace

main :: fn() void = {
    Qbe :: import("@/backend/ir.fr");
    packed :: packed_enum_names(Qbe.O);
    before := @run packed._0.shallow_copy(ast_alloc());
    after := packed._0;
    a := Qbe.O.from_name("add");
    if a { a |
        ::enum(@type a);
        @println("add = % = %", @as(i32) a, a);
    };
    @assert_eq(before, after);
    
    if false {
        self := zeroed(*SelfHosted);
        result := zeroed(Result(RawList(void), *CompileError));
        stmts := self.unwrap_report_errorXX(RawList(void), result);
    };
    
};

unwrap_report_errorXX :: fn(self: *SelfHosted, $T: Type, value: Res(T)) T #generic = {
    @match(value&) {
        fn Ok(it) => it[];
        fn Err(it) => self.report_errorXX(it[], true);
    }
};

fn report_errorXX(self: *SelfHosted, err: *CompileError, color: bool) Never = {
    print(self.log.items()); self.log&.clear();
    out: List(u8) = list(temp());
    self.fmt_errorXX(err, out&, color);
    panic(out.items())
}

fn fmt_errorXX(self: *SelfHosted, err: *CompileError, out: *List(u8), color: bool) void = {
    @match(err) {
        fn InvalidContextualField(it) => {
            show_type_declaration(self, out, it.type, color);
        }
        @default => ();
    };
}