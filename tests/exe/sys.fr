// This is a test of examples: elf_loader/macho_loader and dump_elf/dump_macho. 
// TODO: for now it mostly tests the native target (not cross compiling)

main :: fn() void = {
    macos := query_current_os() == .macos;
    loader := @if(macos, "examples/macho_loader.fr", "examples/elf_loader.fr");
    dump := @if(macos, "examples/dump_macho.fr", "examples/dump_elf.fr");
    franca := get_executable_path(temp());
    
    exe := open_temp_file();
    
    {  // === dynamic .fr ===
    sh(@slice(franca, "examples/default_driver.fr", "build", "examples/toy/hello2.fr", "-o", exe&.s_name()));
    if query_current_arch() != .rv64 {
        a := sh(@slice(franca, loader, exe&.s_name()));
        @assert_eq(a, "Hello World!\n");
    }
    text := sh(@slice(franca, dump, exe&.s_name()));
    if macos {
        @assert(!text.contains("imports_count = 0") && text.contains(") _write") && text.contains(") _exit"));
    } else {
        @assert(text.contains("Dynamic") && text.contains("Interp"), "expected dynamic executable:\n%", text);
    }
    };
    
    {  // === static .fr ===
        sh(@slice(franca, "examples/default_driver.fr", "build", "examples/toy/hello2.fr", "-o", exe&.s_name(), 
            "-syscalls", "-os", "linux"));
        if !macos  && query_current_arch() != .rv64 {
            a := sh(@slice(franca, loader, exe&.s_name()));
            @assert_eq(a, "Hello World!\n");
        };
        text := sh(@slice(franca, "examples/dump_elf.fr", exe&.s_name()));
        @assert(!text.contains("Interp"), "expected static executable:\n%", text);
    };
    
    if query_current_arch() == .rv64 {
        return();
    };
    // === static .fr ===
    // this checks that do_relocations_static_linux works with skew != 0 (on my loader that assumes PIC)
    sh(@slice(franca, "examples/default_driver.fr", "build", "examples/toy/reloc.fr", "-o", exe&.s_name(), "-syscalls"));
    sh(@slice(franca, loader, exe&.s_name()));
    
    // === dynamic .ssa ===
    sh(@slice(franca, "backend/meta/qbe_frontend.fr", "backend/test/hello.ssa", "-o", exe&.s_name()));
    text := sh(@slice(franca, loader, exe&.s_name()));
    @assert_eq(text, "One and one make 2!\n");
}

sh :: import("@/examples/testing.fr").hush;
#use("@/backend/lib.fr");
#use("@/lib/sys/fs.fr");
