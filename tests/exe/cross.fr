
main :: fn() void = {
    if current_os() == .macos && current_arch() == .x86_64 {
        // i've tried it on rosetta2 macos15.4 on an M1 and in github actions macos-13. no luck. 
        @eprintln("SKIP tests/exe/cross.fr/blink(): jart/blink does not appear to work on macos-amd64...?");
        return();
    };
    
    blink();
};

// This builds a linux-amd64 emulator and then uses it to rebuild the compiler (without libc!). 
// Finally it checks that it repros with the one build natively in target/release. 
blink :: fn() void = {
    root := fetch_or_crash(
        "https://github.com/jart/blink/archive/7de0bd8330aa0484b5a66ce627d6d35f9ea5efa2.zip",
        3759302, "1de6a380bd8160d99daabd8d5da7ac381480a82572e6b7049b7c9b2fb7f728ca",
        "blink-7de0bd8330aa0484b5a66ce627d6d35f9ea5efa2",
    );
    start := get_working_directory(temp()).items();
    Syscall'chdir(root.as_cstr()) || @panic("failed to set cwd to %", root);
    if current_os() == .macos && get_environment_variable("GITHUB_REPOSITORY").is_some() {
        // fucking waste of time factory
        sh(@slice("brew", "install", "make"));
    };
    // TODO: ugh, rerunning configure every time changes the modified date so make doesn't cache anything :(
    sh(@slice("./configure")); 
    sh(@slice("gmake"));
    Syscall'chdir(start.as_cstr());
    franca := "target/release/franca-linux-amd64-sta";
    _ := Syscall'remove("a.out");
    sh(@slice(@tfmt("%/o/blink/blink", root), franca, "examples/default_driver.fr", "build", "compiler/main.fr", "-unsafe", "-syscalls"));
    sh(@slice("diff", franca, "a.out"));
};

#use("@/examples/testing.fr");
