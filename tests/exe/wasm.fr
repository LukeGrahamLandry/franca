// TODO: import_wasm/run.fr should cache a dynamic library
// TODO: autotest run this

main :: fn() void = {
    threads := @slice(
        start_thread_nodata {
            franca := get_executable_path(temp());
            hush(@slice(franca, "examples/web/build.fr"));
        },
        start_thread_nodata {
            franca := get_executable_path(temp());
            hush(@slice(franca, "examples/default_driver.fr", "build", "examples/import_wasm/run.fr", "-o", "target/w.out", "-keep-names"));
        },
    );
    for(threads, join);
    
    hello_world();
    B :: import("@/examples/web/build.fr");
    manifest := B'manifest("");
    
    manifest.compilers[0].examples&.ordered_retain(fn(it) => true 
        && it[] != "compiler/main.fr"
        && it[] != "examples/chess/perft.fr"  // slow
        // import_wasm doesn't support graphics yet
        && it[] != "examples/mandelbrot_ui.fr"
        && it[] != "examples/farm_game.fr"
        && it[] != "examples/app_events.fr"
        && it[] != "examples/chess/gui.fr"
        && it[] != "examples/terminal.fr"
    );
    manifest.compilers[1].examples&.ordered_retain(fn(it) => true
        && !it[].ends_with("pragma-once.c") 
        && !it[].ends_with("function.c") 
        && !it[].ends_with("varargs.c") 
        && !it[].ends_with("literal.c")  // 3e+8
        && !it[].ends_with("macro.c") 
        && !it[].ends_with("float.c")  // 2e3
        && !it[].ends_with("cast.c")  // 2e15
        && !it[].ends_with("usualconv.c")  // printf flag 35
    );
    manifest.compilers[2].examples&.ordered_retain(fn(it) => true
        && !it[].ends_with("abi5.ssa")  // snprintf
        && !it[].ends_with("abi6.ssa")  // snprintf
        && !it[].ends_with("abi8.ssa")  // snprintf
        && !it[].ends_with("echo.ssa")
        && !it[].ends_with("fpcnv.ssa")  // 9.499222733527032e+18
        && !it[].ends_with("vararg1.ssa")
        && !it[].ends_with("vararg2.ssa")
        && !it[].ends_with("ops.ssa")  // printf flag 35
        && !it[].ends_with("mem1.ssa")  // printf flag 35
        && !it[].ends_with("load2.ssa")  // printf flag 48
        && !it[].ends_with("load4.ssa")  // TODO: why fail?
        && !it[].ends_with("env.ssa")    // TODO: why fail?
    );
    manifest.compilers.len = 3;  // [3] tries to read mandel.txt which is created in examples/web/build.fr
    each manifest.compilers { it |
        run_tests_main_threaded(Str, Str, it.name, it.examples, fn(_, it) = it[], fn(name, file) = {
            a := @slice("examples/web/target/demo.wasm", "--", "-lang", name, "-file", file[]);
            ok, o, e := exec_and_catch("target/w.out", a, temp());
            (ok, o, e, "")
        });
    };
}

// tiny example that doesn't even have a __stackbase
hello_world :: fn() void = {
    #use("@/examples/bf/via_wasm.fr");
    #use("@/examples/bf/README.fr");
    wasm := to_wasm_module(temp(), HELLO_WORLD).items();
    write_entire_file_or_crash("target/hello.wasm", wasm);
    sh(@slice("target/w.out", "target/hello.wasm"));
};

#use("@/lib/sys/process.fr");
#use("@/lib/sys/subprocess.fr");
#use("@/examples/testing.fr");
