
main :: fn() void = {
    franca := get_executable_path(temp());
    hush(@slice(franca, "graphics/web/webgpu_api.fr"));
    hush(@slice(franca, "examples/default_driver.fr", "build", "examples/os/host/web.fr", "-o", "examples/web/target/demo.wasm", "-arch", "wasm32", "-unsafe", "-dynamiclib", "-keep-names"));
    wasm := temp().read_to_string_or_crash("examples/web/target/demo.wasm").items();
    a := general_allocator();
    rt: Rt.Engine = init_for_jit(a, "");
    hello_world(rt&);
    mod := rt&.compile(wasm);
    
    manifest := collect_tests();
    each manifest.compilers { it |
        State :: @struct(rt: *Rt.Engine, mod: *Rt.Module, name: CStr);
        state: State = (rt = rt&, mod = mod, name = it.name.as_cstr());
        run_tests_main_threaded(*State, Str, state&, it.examples, fn(_, it) = it[], fn(state, file) = {
            a: []CStr = @slice(as_cstr "examples/web/target/demo.wasm", "-lang", state.name, "-file", as_cstr file[]);
            out := u8.list(temp());
            log: Runner.Log = (ctx = List(u8).raw_from_ptr(out&), f = fn(out, _, msg) = {
                out := List(u8).ptr_from_raw(out);
                out.push_all(msg);
            });
            Runner'exec_wasm_file(Runner.AugmentedExports, state.rt, state.mod, a, log);
            (true, out, list(temp()), "")
        });
    };
}

collect_tests :: fn() = {
    B :: import("@/examples/web/build.fr");
    manifest := B'manifest("");
    
    manifest.compilers[0].examples&.ordered_retain(fn(it) => true 
        && it[] != "compiler/main.fr"
        && it[] != "examples/chess/perft.fr"  // slow
        // import_wasm doesn't support graphics yet
        && it[] != "examples/mandelbrot_ui.fr"
        && it[] != "examples/farm_game.fr"
        && it[] != "examples/app_events.fr"
        && it[] != "examples/chess/gui.fr"
        && it[] != "examples/terminal.fr"
    );
    manifest.compilers[1].examples&.ordered_retain(fn(it) => true
        && !it[].ends_with("pragma-once.c") 
        && !it[].ends_with("function.c") 
        && !it[].ends_with("varargs.c") 
        && !it[].ends_with("literal.c")  // 3e+8
        && !it[].ends_with("macro.c") 
        && !it[].ends_with("float.c")  // 2e3
        && !it[].ends_with("cast.c")  // 2e15
        && !it[].ends_with("usualconv.c")  // printf flag 35
    );
    manifest.compilers[2].examples&.ordered_retain(fn(it) => true
        && !it[].ends_with("abi5.ssa")  // snprintf
        && !it[].ends_with("abi6.ssa")  // snprintf
        && !it[].ends_with("abi8.ssa")  // snprintf
        && !it[].ends_with("echo.ssa")
        && !it[].ends_with("fpcnv.ssa")  // 9.499222733527032e+18
        && !it[].ends_with("vararg1.ssa")
        && !it[].ends_with("vararg2.ssa")
        && !it[].ends_with("ops.ssa")  // printf flag 35
        && !it[].ends_with("mem1.ssa")  // printf flag 35
        && !it[].ends_with("load2.ssa")  // printf flag 48
        && !it[].ends_with("load4.ssa")  // TODO: why fail?
        && !it[].ends_with("env.ssa")    // TODO: why fail?
    );
    manifest
}

// tiny example that doesn't even have a __stackbase
hello_world :: fn(rt: *Rt.Engine) void = {
    #use("@/examples/bf/via_wasm.fr");
    #use("@/examples/bf/README.fr");
    wasm := to_wasm_module(temp(), HELLO_WORLD).items();
    mod := rt.compile(wasm);
    Runner'exec_wasm_file(Runner.AugmentedExports, rt, mod, empty(), Runner.standard_log);
};

#use("@/lib/sys/process.fr");
#use("@/lib/sys/subprocess.fr");
#use("@/examples/testing.fr");
Rt :: import("@/examples/import_wasm/runtime.fr");
Runner :: import("@/examples/import_wasm/run.fr");
