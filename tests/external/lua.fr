fn main() void = {
    #use("@/examples/testing.fr");
    
    start := get_working_directory(temp()).items();
    cc_path := @tfmt("%/target/cc.out", start);
    
    lua_folder := Foreign'lua();
    tests_folder := Foreign'luatests();

    files := collect_with_extension(@tfmt("%/src", lua_folder), ".c") || panic("didn't find tests. run from franca root dir");
    src := u8.list(files.len * 20, temp());
    for files { it |
        @if(it != "all.c" && it != "luac.c")
        @fmt(src&, "#include \"%/src/%\"\n", lua_folder, it);
    };
    //@fmt(src&, "#include \"%/tests/ltests.c\"\n", lua_folder);  // TODO
    all_path := @tfmt("%/src/all.c", lua_folder); 
    write_entire_file_or_crash(all_path, src.items());
    lua_exe := @tfmt("%/%/lua.out", start, lua_folder);

    ok, out, err := exec_and_catch(cc_path, @slice(all_path, "-o", lua_exe, "-DLUA_USE_POSIX"), temp());  // , "-I."
    if !ok {
        @panic("failed compile lua\n%", err.items());
    };
    
    // TODO: instead of this just run all.lua but that needs to setup building libs
    // is imported: "bwcoercion.lua", "tracegc.lua", 
    // slow: "heavy.lua", 
    // entry: "all.lua", "main.lua"
    // internal: "api.lua", "code.lua", 
    // needs to be called from a coroutine: "big.lua", 
    // idk but it fails with clang too: "files.lua", 
    tests :: @const_slice("tpack.lua", "utf8.lua", "vararg.lua", "verybig.lua",
    "attrib.lua", "bitwise.lua", "calls.lua", 
    "closure.lua", "constructs.lua", "coroutine.lua", "cstack.lua", "db.lua", "errors.lua", 
    "events.lua", "gc.lua", "gengc.lua", "goto.lua", "literals.lua", "locals.lua", 
    "math.lua", "nextvar.lua", "pm.lua", "sort.lua", "strings.lua");  
   
    Sort :: import("@/lib/sort.fr");
    sort :: Sort'quicksort(Str, Sort.order_strings);
    :: sort(tests);
    Syscall'chdir(@fmt_cstr("%", tests_folder)).unwrap();
    run_tests_main(Str, tests, fn(a) => a[]) { file | 
        a := timestamp();
        ok, out, err := exec_and_catch(lua_exe, @slice(file[]), temp());
        b := timestamp();
        ok := ok && (out.items().contains("OK\n") || out.items().contains("ok\n"));
        (ok, out, err, @tfmt("%ms", b - a))
    };
    
    // TODO: this doesn't seem to work. do their tests just not support 
    //       running in parallel (maybe they stomp files like some of mine do)
    //run_tests_main_threaded(Str, Str, lua_exe, tests, fn(_, a) = a[], fn(lua_exe, file) = {
    //    ok, out, err := exec_and_catch(lua_exe, @slice(file[]), temp());
    //    ok := ok && (out.items().contains("OK\n") || out.items().contains("ok\n"));
    //    (ok, out, err, "")
    //});
}
