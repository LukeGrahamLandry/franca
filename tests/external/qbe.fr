// TODO: test that i can compile qbe itself as well, not just minic
//       could also use its output as more tests for my (very limmited) assembler. 

// This is called to generate queen.ssa
// note: (recent) minic always puts the varargs marker at the end of a call so it doesn't work on apple-arm or riscv
//       (and doesn't reproduce the committed queen.ssa)
// TODO: compile the c compiler instead of hoping cc.out already exists. 
compile_with_minic :: fn($qbe_commit: Str, c_source: Str) Str = {
    #use("@/examples/testing.fr");
    @assert_eq(qbe_commit, "d9f1121763c126316ab338ca8b1b9d51967a33b1");
    root := Foreign'qbeminic();
    // use qbe's yacc to generate minic's source. 
    sh(@slice("target/cc.out", @tfmt("%/minic/yacc.c", root), "-r", "--", 
         "-b", "target/y", @tfmt("%/minic/minic.y", root)));
    // use minic to generate ir.
    ok, out, err := exec_and_catch("target/cc.out", @slice(
        "target/y.tab.c", "-r", "--",
    ), temp(), c_source);
    @assert(ok, "minic failed! output:\n%%", out.items(), err.items());
    @if(err.len != 0) println(err.items());
    out.items()
}
