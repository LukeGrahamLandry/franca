#test #use("@/lib/sys/jump.fr")
fn exceptional(canary: i64) i64 = {
    #use("@/lib/sys/process.fr");
    @if(query_current_arch() == .wasm32) return(canary);  // SKIP: TODOWASM
    
    buf := JumpBuf.zeroed();
    // Very old comment but still less fragile to do it this way: 
    // this can't just be a local variable because C backend clang with -O2 doesn't load it again at the end. 
    // i tried marking `try` __attribute__((returns_twice)) and I tried making all the locals volatile... doesn't work!
    // but this indirection works (with or without returns_twice).
    my_value := temp().boxed(i64, 0);
    
    @match(try(buf&)) {
        fn Try() => {
            assert_eq(my_value[], 0);
            my_value[] = 1;
            throw(buf&);
        };
        fn Catch() => {
            assert_eq(my_value[], 1);
            my_value[] = 2;
        };
    };
    assert_eq(my_value[], 2);
    canary
}
